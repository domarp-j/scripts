#!/bin/bash

### SOURCE: https://docs.docker.com/compose/rails/

# Ensure that argument was passed in
if [ "$1" == '' ]; then
  echo "Please pass in the name of the new Rails app as an argument."
  exit 1
fi

# Get name of Rails app as argument
APP=$1

# Make a directory called APP and cd into it
mkdir "${APP}"
cd "${APP}"

# Create a dummy Gemfile and Gemfile.lock that will be overriden by rails new .
echo "Creating simple Gemfile & blank Gemfile.lock (soon to be overridden by Docker)..."
touch Gemfile
cat <<EOF >> Gemfile

source 'https://rubygems.org'
gem 'rails', '5.0.0.1'

EOF
touch Gemfile.lock

# Create Dockerfile
echo "Creating Dockerfile..."
touch Dockerfile
cat <<EOF >> Dockerfile

FROM ruby:2.3.4
RUN apt-get update && apt-get install -y build-essential libpq-dev nodejs
RUN mkdir -p /${APP}
WORKDIR /${APP}
COPY Gemfile /${APP}/Gemfile
COPY Gemfile.lock /${APP}/Gemfile.lock
RUN gem install bundler && bundle install
COPY . /${APP}

EOF

# Create docker-compose.yml
echo "Creating docker-compose.yml..."
touch docker-compose.yml
cat <<EOF >> docker-compose.yml

version: '3'
services:
  db:
    image: postgres
  web:
    build: .
    command: bundle exec rails s -p 3000 -b '0.0.0.0'
    volumes:
      - .:/${APP}
    ports:
      - "3000:3000"
    depends_on:
      - db

EOF

# Create Rails app with PostgreSQL setup, skipping turbolinks & coffeescript
echo "Creating Rails app with PostgreSQL..."
docker-compose run web rails new . --database=postgresql --skip-turbolinks --skip-coffee --force

# Build images based on docker-compose.yml
echo "Building images from docker-compose.yml..."
docker-compose build

# Request permission for further edits
echo "Granting permission to non-root user, if needed..."
sudo chown -R $USER:$USER .

# Update database.yml
echo "Renaming database.yml to database.yml.original..."
cd config
mv database.yml database.yml.original
echo "Creating new database.yml"
touch database.yml
cat <<EOF >> database.yml

# This database.yml file was generated by the quick_rails_docker_setup script
# The old database.yml file has been renamed to database.yml.original

default: &default
  adapter: postgresql
  encoding: unicode
  host: db
  username: postgres
  password:
  pool: 5

development:
  <<: *default
  database: ${APP}_development

test:
  <<: *default
  database: ${APP}_test

production:
  <<: *default
  database: ${APP}_production

EOF

# Create database
echo "Creating new PostgreSQL database..."
docker-compose run web rake db:create

# Done message
echo "Done! Run \"docker-compose up\" whenver you're ready."

